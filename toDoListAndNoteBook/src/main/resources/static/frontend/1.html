<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoList & Notebook</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* 全局优化 */
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --danger-color: #F56C6C;
            --bg-color: #f5f7fa;
            --card-radius: 12px;
        }

        body {
            background: var(--bg-color);
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC',
            'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* 主容器 */
        .app-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 30px;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        /* 选项卡优化 */
        .el-tabs__header {
            margin: 0 0 25px;
            border-bottom-color: #e4e7ed;
        }

        .el-tabs__item {
            font-size: 16px;
            font-weight: 500;
            padding: 0 28px;
            transition: color 0.3s;
        }

        .el-tabs__item.is-active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .el-tabs__active-bar {
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), #6cb8ff);
            border-radius: 2px;
        }

        /* 卡片设计 */
        .card-container {
            margin-bottom: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        }

        .el-card {
            border-radius: var(--card-radius) !important;
            border: 1px solid #ebeef5;
        }

        .el-card__body {
            padding: 20px 24px;
        }

        /* 卡片头部布局 */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 操作按钮组 */
        .card-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card-container:hover .card-actions {
            opacity: 1;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s !important;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        /* 状态标签 */
        .status-tag {
            border-radius: 6px;
            padding: 0 12px;
            height: 28px;
            line-height: 28px;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* 内容区域 */
        .card-content {
            color: #606266;
            line-height: 1.6;
            margin: 12px 0;
        }

        .card-footer {
            color: #909399;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 过滤栏 */
        .filter-container {
            padding: 18px;
            background: #f8fafc;
            border-radius: var(--card-radius);
            margin-bottom: 25px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-item {
            flex: 1 1 200px;
            min-width: 200px;
        }

        .filter-item .el-input__inner,
        .filter-item .el-range-input,
        .filter-item .el-select-dropdown__item {
            height: 40px;
            line-height: 40px;
        }

        .filter-button {
            height: 40px;
            padding: 0 24px;
        }

        /* 调整日期选择器宽度 */
        .el-date-editor.el-range-editor {
            width: 280px;
        }

        /* 分页优化 */
        .el-pagination {
            margin-top: 30px;
            justify-content: center;
        }

        /* 对话框优化 */
        .el-dialog {
            border-radius: 12px !important;
        }

        .el-dialog__header {
            border-bottom: 1px solid #ebeef5;
            padding: 15px 20px;
        }

        .el-dialog__body {
            padding: 25px 30px;
        }

        /* 空状态提示 */
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #909399;
        }

        .expand-button {
            margin-top: 10px;
            text-align: right;
            color: var(--primary-color); /* 使用全局变量定义的颜色 */
            transition: color 0.3s; /* 添加颜色过渡效果 */
        }

        .expand-button:hover {
            color: #66b1ff; /* 鼠标悬停时按钮颜色变化 */
        }

        /* 附件样式 */
        .attachments {
            margin-top: 15px;
            border-top: 1px solid #ebeef5;
            padding-top: 12px;
        }

        .file-actions {
            margin-left: 10px;
        }

        /* 文件上传优化 */
        .el-upload__tip {
            color: #909399;
            font-size: 12px;
            margin-top: 8px;
        }

        /* 文件预览弹窗 */
        .image-preview-modal .el-dialog__body {
            padding: 10px;
            text-align: center;
        }

        /* 文件列表优化 */
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 6px 0;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .file-item:hover {
            background: #f1f3f5;
        }

        .file-info {
            flex: 1;
            margin-left: 8px;
        }

        .file-name {
            font-size: 13px;
            color: #606266;
        }

        .file-size {
            font-size: 12px;
            color: #909399;
        }

        /* 响应式布局 */
        @media (max-width: 768px) {
            .app-container {
                margin: 15px;
                padding: 20px;
            }

            .card-header {
                flex-wrap: wrap;
                gap: 10px;
            }

            .card-actions {
                opacity: 1;
                width: 100%;
                justify-content: flex-end;
            }

            .filter-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div id="app">
    <div class="app-container">
        <el-tabs v-model="activeTab">
            <!-- 待办事项模块 -->
            <el-tab-pane label="待办事项" name="todo">
                <div class="operation-bar">
                    <el-button type="primary" icon="el-icon-plus" @click="showTodoDialog">新建待办</el-button>
                </div>

                <!-- 过滤条件 -->
                <div class="filter-container">
                    <el-input
                            class="filter-item"
                            v-model="todoQuery.title"
                            placeholder="搜索标题"
                            clearable
                            suffix-icon="el-icon-search">
                    </el-input>

                    <el-date-picker
                            class="filter-item"
                            v-model="todoQuery.dateRange"
                            type="daterange"
                            range-separator="至"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期">
                    </el-date-picker>

                    <el-select
                            class="filter-item"
                            v-model="todoQuery.status"
                            placeholder="状态筛选"
                            clearable>
                        <el-option label="未完成" :value="0"></el-option>
                        <el-option label="已完成" :value="1"></el-option>
                    </el-select>

                    <el-button
                            class="filter-button"
                            type="primary"
                            icon="el-icon-search"
                            @click="fetchTodos">
                        搜索
                    </el-button>
                </div>

                <!-- 待办列表 -->
                <template v-if="todos.length">
                    <div class="card-container" v-for="todo in todos" :key="'todo-'+todo.id">
                        <el-card>
                            <div class="card-header">
                                <div class="card-title">
                                    <el-tag
                                            :type="todo.status ? 'success' : 'danger'"
                                            class="status-tag"
                                            @click="toggleTodoStatus(todo)">
                                        {{ todo.status ? '已完成' : '未完成' }}
                                    </el-tag>
                                    <span>{{ todo.title }}</span>
                                </div>
                                <div class="card-actions">
                                    <el-button
                                            class="action-btn"
                                            icon="el-icon-edit"
                                            @click="editTodo(todo)"></el-button>
                                    <el-button
                                            class="action-btn"
                                            type="danger"
                                            icon="el-icon-delete"
                                            @click="deleteTodo(todo.id)"></el-button>
                                </div>
                            </div>
                            <div class="card-content" v-if="todo.showFullContent">
                                {{ todo.description }}
                            </div>

                            <!-- 待办事项模块中的展开按钮 -->
                            <div class="card-footer">
                                <span>截止日期：{{ formatDate(todo.dueDate) }}</span>
                                <el-button
                                        class="expand-button"
                                        type="text"
                                        @click="toggleExpand(todo)">
                                    {{ todo.showFullContent ? '收起' : '展开' }}内容
                                    <i :class="todo.showFullContent ? 'el-icon-arrow-up' : 'el-icon-arrow-down'"></i>
                                </el-button>
                            </div>

                        </el-card>
                    </div>
                </template>
                <div v-else class="empty-state">
                    <i class="el-icon-notebook-2" style="font-size: 48px;"></i>
                    <p>暂无待办事项</p>
                </div>

                <!-- 分页 -->
                <el-pagination
                        @current-change="handleTodoPageChange"
                        :current-page.sync="todoPager.page"
                        :page-size="pageSize"
                        layout="prev, pager, next"
                        :total="todoPager.total">
                </el-pagination>
            </el-tab-pane>

            <!-- 笔记模块 -->
            <el-tab-pane label="笔记" name="note">
                <div class="operation-bar">
                    <el-button type="primary" icon="el-icon-plus" @click="showNoteDialog">新建笔记</el-button>
                </div>

                <!-- 搜索 -->
                <div class="filter-container">
                    <el-input
                            class="filter-item"
                            v-model="noteQuery.title"
                            placeholder="搜索标题"
                            clearable
                            suffix-icon="el-icon-search">
                    </el-input>
                    <el-button
                            class="filter-button"
                            type="primary"
                            @click="fetchNotes">
                        搜索
                    </el-button>
                </div>

                <!-- 笔记列表 -->
                <template v-if="notes.length">
                    <div class="card-container" v-for="note in notes" :key="'note-'+note.id">
                        <el-card>
                            <div class="card-header">
                                <span class="card-title">{{ note.title }}</span>
                                <div class="card-actions">
                                    <el-button
                                            class="action-btn"
                                            icon="el-icon-edit"
                                            @click="editNote(note)"></el-button>
                                    <el-button
                                            class="action-btn"
                                            type="danger"
                                            icon="el-icon-delete"
                                            @click="deleteNote(note.id)"></el-button>
                                </div>
                            </div>
                            <pre class="card-content" v-if="note.showFullContent">{{ note.content }}</pre>

                            <!-- 笔记模块中的展开按钮 -->
                            <div class="card-footer">
                                <span>最后更新：{{ formatDateTime(note.updatedAt || note.createdAt) }}</span>
                                <el-button
                                        class="expand-button"
                                        type="text"
                                        @click="toggleExpandNote(note)">
                                    {{ note.showFullContent ? '收起' : '展开' }}内容
                                    <i :class="note.showFullContent ? 'el-icon-arrow-up' : 'el-icon-arrow-down'"></i>
                                </el-button>
                            </div>

                            <div class="attachments" v-if="note.attachedFiles?.length">
                                <div class="file-item" v-for="file in note.attachedFiles" :key="file.id">
                                    <i :class="getFileIcon(file.fileType)"></i>
                                    <span class="file-name">{{ file.originalName }}</span>

                                    <!-- 操作按钮 -->
                                    <el-button-group class="file-actions">
                                        <el-button
                                                size="mini"
                                                @click="previewFile(file)">
                                            预览
                                        </el-button>
                                        <el-button
                                                size="mini"
                                                @click="downloadFile(file)">
                                            下载
                                        </el-button>
                                    </el-button-group>
                                </div>
                            </div>
                        </el-card>
                    </div>
                </template>
                <div v-else class="empty-state">
                    <i class="el-icon-document" style="font-size: 48px;"></i>
                    <p>暂无笔记记录</p>
                </div>

                <!-- 分页 -->
                <el-pagination
                        @current-change="handleNotePageChange"
                        :current-page.sync="notePager.page"
                        :page-size="pageSize"
                        layout="prev, pager, next"
                        :total="notePager.total">
                </el-pagination>
            </el-tab-pane>
        </el-tabs>
    </div>

    <!-- 待办事项弹窗 -->
    <el-dialog :title="todoDialogTitle" :visible.sync="todoDialogVisible" width="600px">
        <el-form :model="currentTodo" label-width="90px" ref="todoForm">
            <el-form-item label="标题" prop="title">
                <el-input v-model="currentTodo.title" placeholder="请输入待办标题"></el-input>
            </el-form-item>
            <el-form-item label="描述" prop="description">
                <el-input
                        type="textarea"
                        :rows="3"
                        v-model="currentTodo.description"
                        placeholder="请输入详细描述（可选）"></el-input>
            </el-form-item>
            <el-form-item label="截止日期" prop="dueDate">
                <el-date-picker
                        v-model="currentTodo.dueDate"
                        type="date"
                        value-format="yyyy-MM-dd"
                        placeholder="选择截止日期">
                </el-date-picker>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="todoDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="saveTodo">保存</el-button>
        </div>
    </el-dialog>

    <!-- 笔记弹窗 -->
    <el-dialog :title="noteDialogTitle" :visible.sync="noteDialogVisible" width="700px">
        <el-form :model="currentNote" label-width="90px" ref="noteForm">
            <el-form-item label="标题" prop="title">
                <el-input v-model="currentNote.title" placeholder="请输入笔记标题"></el-input>
            </el-form-item>
            <el-form-item label="内容" prop="content">
                <el-input
                        type="textarea"
                        :rows="6"
                        v-model="currentNote.content"
                        placeholder="开始记录你的想法..."
                        resize="none"></el-input>
            </el-form-item>

            <el-form-item label="附件">
                <el-upload
                        multiple
                        action=""
                        :file-list="fileList"
                        :auto-upload="false"
                        :on-change="handleFileChange"
                        :on-remove="handleFileRemove"
                        :before-remove="beforeFileRemove"
                        accept=".jpg,.jpeg,.png,.pdf"
                        :limit="5"
                        :on-exceed="handleExceed">
                    <el-button size="small" type="primary">选择文件</el-button>
                    <div slot="tip" class="el-upload__tip">
                        支持图片（JPEG/PNG）和PDF，单个文件不超过10MB，最多5个文件
                    </div>
                </el-upload>

                <!-- 文件列表展示 -->
                <div class="file-list" v-if="currentNote.attachedFiles?.length">
                    <div class="file-item" v-for="file in currentNote.attachedFiles" :key="file.id">
                        <i :class="getFileIcon(file.fileType)" style="font-size: 20px;"></i>
                        <div class="file-info">
                            <div class="file-name">{{ file.originalName }}</div>
                            <div class="file-size">{{ formatFileSize(file.size) }}</div>
                        </div>
                        <el-button-group class="file-actions">
                            <el-button size="mini" @click="previewFile(file)">预览</el-button>
                            <el-button size="mini" @click="downloadFile(file)">下载</el-button>
                        </el-button-group>
                    </div>
                </div>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="noteDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="saveNote">保存</el-button>
        </div>
    </el-dialog>

</div>

<script src="vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://unpkg.com/dayjs"></script>
<script src="https://unpkg.com/moment@2.29.1/min/moment.min.js"></script>
<script src="https://unpkg.com/moment-timezone@0.5.33/builds/moment-timezone-with-data.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script>
    // axios.defaults.withCredentials = true;  // 允许携带凭证
    // 检查登录状态
    if (!localStorage.getItem('jwt_token')) {
        window.location.href = 'login.html';
    }
    // 添加请求拦截器
    axios.interceptors.request.use(config => {
        const token = localStorage.getItem('jwt_token');
        console.log('[拦截器] Token:', token); // 调试输出
        console.log('[拦截器] 请求URL:', config.url); // 调试输出
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    }, error => {
        console.error('[拦截器] 请求错误:', error); // 错误输出
        return Promise.reject(error);
    });

    // 添加响应拦截器
    axios.interceptors.response.use(response => {
        return response;
    }, error => {
        if (error.response.status === 401) {
            localStorage.removeItem('jwt_token');
            window.location.href = 'login.html';
        }
        return Promise.reject(error);
    });

    new Vue({
        el: '#app',
        data() {
            return {
                baseURL: 'http://localhost:8088/toDoListAndNoteBook',
                activeTab: 'todo',
                todos: [],
                currentTodo: {},
                todoDialogVisible: false,
                todoDialogTitle: '新建待办',
                todoQuery: { title: '', dateRange: [], status: '' },
                todoPager: { page: 1, total: 0 },
                pageSize: 5,  // 默认为5
                notes: [],
                currentNote: {},
                noteDialogVisible: false,
                noteDialogTitle: '新建笔记',
                noteQuery: { title: '' },
                notePager: { page: 1, total: 0 },
                deletedFiles: []
            };
        },
        computed: {
            // 修改：为每个文件对象补充 fileType 信息，确保预览时正确判断文件类型
            fileList() {
                return (this.currentNote.attachedFiles || []).map(file => ({
                    name: file.originalName,
                    size: file.size,
                    id: file.id,
                    fileType: file.fileType,  // 新增属性
                    status: 'success'
                }));
            }
        },
        watch: {
            // 监听分页大小变化
            pageSize() {
                if (this.activeTab === 'todo') {
                    this.todoPager.page = 1;
                    this.fetchTodos();
                } else {
                    this.notePager.page = 1;
                    this.fetchNotes();
                }
            }
        },
        mounted() {
            this.fetchTodos();
            this.fetchNotes();
        },
        methods: {

            // 修改后的fetchTodos方法
            async fetchTodos() {
                let url = `${this.baseURL}/todos/getAll`;
                const params = {
                    pageNum: this.todoPager.page,
                    pageSize: this.pageSize
                };

                if (this.todoQuery.title) {
                    url = `${this.baseURL}/todos/getByTitle`;
                    params.title = this.todoQuery.title;
                }

                if (this.todoQuery.dateRange?.length === 2) {
                    const startDate = this.formatDate(this.todoQuery.dateRange[0]);
                    const endDate = this.formatDate(this.todoQuery.dateRange[1]);
                    params.startDate = startDate;
                    params.endDate = endDate;

                    if (this.todoQuery.status !== '') {
                        url = `${this.baseURL}/todos/getByDueDateAndStatus`;
                        params.status = this.todoQuery.status;
                    } else {
                        url = `${this.baseURL}/todos/getByDueDate`;
                    }
                } else if (this.todoQuery.status !== '') {
                    url = `${this.baseURL}/todos/getByStatus`;
                    params.status = this.todoQuery.status;
                }

                try {
                    const res = await axios.get(url, { params });
                    this.todos = res.data.data.todos.map(todo => ({
                        ...todo,
                        showFullContent: false, // 默认不展开内容
                        dueDate: todo.dueDate ? new Date(todo.dueDate) : null,
                        updatedAt: todo.updatedAt ? Number(todo.updatedAt) * 1000 : null
                    }));
                    this.todoPager.total = res.data.data.total || 0;
                } catch (error) {
                    this.$message.error('获取待办数据失败');
                }
            },

            // 修改后的fetchNotes方法
            async fetchNotes() {
                let url = `${this.baseURL}/notes/getAll`;
                const params = {
                    pageNum: this.notePager.page,
                    pageSize: this.pageSize,
                };
                if (this.noteQuery.title) {
                    url = `${this.baseURL}/notes/getByTitle`;
                    params.title = this.noteQuery.title;
                }
                try {
                    const res = await axios.get(url, { params });
                    this.notes = res.data.data.notes.map(note => ({
                        ...note,
                        showFullContent: false,
                        updatedAt: note.updatedAt ? Number(note.updatedAt) * 1000 : null
                    }));
                    this.notePager.total = res.data.data.total || 0;
                } catch (error) {
                    this.$message.error('获取数据失败');
                }
            },

            showTodoDialog() {
                this.currentTodo = { status: 0 };
                this.todoDialogTitle = '新建待办';
                this.todoDialogVisible = true;
            },

            // 删除待办事项
            async deleteTodo(id) {
                try {
                    await this.$confirm('确认删除该待办事项吗？', '提示', { type: 'warning' });
                    await axios.delete(`${this.baseURL}/todos?id=${id}`);
                    this.$message.success('删除成功');
                    this.fetchTodos();
                } catch (error) {
                    if (error !== 'cancel') {
                        this.$message.error('删除失败');
                    }
                }
            },

            // 切换待办事项状态
            async toggleTodoStatus(todo) {
                try {
                    const newStatus = todo.status === 0 ? 1 : 0;
                    await axios.put(`${this.baseURL}/todos`, { ...todo, status: newStatus });
                    this.fetchTodos();
                } catch (error) {
                    this.$message.error('状态更新失败');
                }
            },

            // 修改编辑待办方法
            editTodo(todo) {
                // 深拷贝对象避免直接修改原始数据
                this.currentTodo = {
                    ...todo,
                    dueDate: todo.dueDate ? new Date(todo.dueDate) : null
                };
                this.todoDialogTitle = '编辑待办';
                this.todoDialogVisible = true;
            },

            // 修改保存待办方法（添加表单验证）
            async saveTodo() {
                if (!this.currentTodo.title?.trim()) {
                    this.$message.error('标题不能为空');
                    return;
                }
                if (this.currentTodo.title.trim().length > 50) {
                    this.$message.error('标题长度不能超过50字符');
                    return;
                }
                if (!this.currentTodo.dueDate) {
                    this.$message.error('请选择截止日期');
                    return;
                }

                try {
                    const todoData = {
                        ...this.currentTodo,
                        dueDate: dayjs(this.currentTodo.dueDate).format('YYYY-MM-DD')
                    };

                    const res = await (todoData.id ?
                        axios.put(`${this.baseURL}/todos`, todoData) :
                        axios.post(`${this.baseURL}/todos`, todoData));

                    this.$message.success('保存成功');
                    this.todoDialogVisible = false;

                    // 智能更新列表（减少重复请求）
                    if (todoData.id) {
                        const index = this.todos.findIndex(t => t.id === todoData.id);
                        if (index > -1) {
                            this.todos.splice(index, 1, res.data.data);
                        }
                    } else {
                        this.todoPager.page = 1; // 新增条目跳转第一页
                        this.fetchTodos();
                    }
                } catch (error) {
                    this.$message.error(error.response?.data?.message || '保存失败');
                }
            },

            // 初始化编辑时的文件列表
            editNote(note) {
                // 修改：保留附加文件的完整信息，方便预览时判断文件类型
                this.currentNote = {
                    ...note,
                    attachedFiles: note.attachedFiles?.map(f => ({
                        name: f.originalName,
                        id: f.id,
                        fileType: f.fileType,  // 新增属性
                        size: f.size,
                        status: 'success'
                    })) || []
                };
                this.noteDialogTitle = '编辑笔记';
                this.noteDialogVisible = true;
            },

            async saveNote() {
                // 表单验证
                if (!this.currentNote.title?.trim()) {
                    this.$message.error('标题不能为空');
                    return;
                }
                if (this.currentNote.title.trim().length > 50) {
                    this.$message.error('标题长度不能超过50字符');
                    return;
                }
                if (!this.currentNote.content?.trim()) {
                    this.$message.error('内容不能为空');
                    return;
                }

                try {
                    const formData = new FormData();

                    // 构造完整的 NoteFile 对象数组（Note.java 中 attachedFiles 需要）
                    const attachedFiles = this.fileList
                        .filter(f => f.id && !this.deletedFiles.includes(f.id))
                        .map(f => ({
                            id: f.id,
                            originalName: f.originalName || '',
                            storedName: f.storedName || '',
                            filePath: f.filePath || '',
                            fileType: f.fileType || '',
                            size: f.size || 0,
                            createdAt: f.createdAt || null,
                            noteId: f.noteId || null,
                            userId: f.userId || null,
                            fileHash: f.fileHash || ''
                        }));

                    // 创建包含完整 attachedFiles 的 note 对象
                    const noteBlob = new Blob([JSON.stringify({
                        id: this.currentNote.id,
                        title: this.currentNote.title,
                        content: this.currentNote.content,
                        attachedFiles: attachedFiles
                    })], { type: "application/json" });

                    formData.append('note', noteBlob, 'note.json');

                    // 添加上传的新文件
                    if (this.currentNote.uploadFiles) {
                        this.currentNote.uploadFiles.forEach(file => {
                            formData.append('files', file);
                        });
                    }

                    // 添加删除文件 ID（@RequestParam 绑定）
                    if (this.deletedFiles && this.deletedFiles.length > 0) {
                        this.deletedFiles.forEach(id => {
                            formData.append('deletedFiles', id);
                        });
                    }

                    // 上传提示
                    this.$message.info('文件上传中，请稍候...');

                    const url = `${this.baseURL}/notes`;
                    const res = await (this.currentNote.id
                        ? axios.put(url, formData) // PUT for update
                        : axios.post(url, formData)); // POST for create

                    this.$message.success('保存成功');
                    this.noteDialogVisible = false;

                    const updatedNote = res.data.data;
                    if (this.currentNote.id) {
                        const index = this.notes.findIndex(n => n.id === this.currentNote.id);
                        if (index > -1) {
                            updatedNote.attachedFiles = res.data.data.attachedFiles || [];
                            this.notes.splice(index, 1, updatedNote);
                        }
                    } else {
                        this.notePager.page = 1;
                        this.fetchNotes();
                    }

                } catch (error) {
                    if (error.response?.status === 413) {
                        this.$message.error('文件大小超过服务器限制');
                    } else if (error.response?.data?.code === 3) {
                        this.$message.error(`文件类型不支持: ${error.response.data.message}`);
                    } else if (error.response?.data?.code === 4) {
                        this.$message.error('文件大小超过10MB限制');
                    } else {
                        this.$message.error(error.response?.data?.message || '保存失败');
                    }
                }
            },

            // 显示笔记弹窗
            showNoteDialog() {
                this.currentNote = {};
                this.noteDialogTitle = '新建笔记';
                this.noteDialogVisible = true;
            },

            // 删除笔记
            async deleteNote(id) {
                try {
                    await this.$confirm('确认删除该笔记吗？', '提示', { type: 'warning' });
                    await axios.delete(`${this.baseURL}/notes?id=${id}`);
                    this.$message.success('删除成功');
                    this.fetchNotes();
                } catch (error) {
                    if (error !== 'cancel') {
                        this.$message.error('删除失败');
                    }
                }
            },

            // 修改后的文件预览方法
            previewFile(file) {
                axios.get(`${this.baseURL}/notes/getFiles?fileId=${file.id}`, {
                    responseType: 'blob'
                }).then(response => {
                    const blob = new Blob([response.data], { type: response.headers['content-type'] });
                    const fileUrl = window.URL.createObjectURL(blob);

                    const styles = `
                        <style>
                            @keyframes fadeIn {
                                from { opacity: 0; }
                                to { opacity: 1; }
                            }
                            .image-preview-modal {
                                width: auto !important;
                                max-width: 90vw;
                                max-height: 90vh;
                                padding: 0;
                                margin: 0;
                                background: transparent;
                            }
                            #preview-container {
                                width: 80vw;
                                height: 80vh;
                                background: #fff;
                                border-radius: 10px;
                                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                position: relative;
                                overflow: hidden;
                                touch-action: none;
                                animation: fadeIn 0.3s ease;
                                user-select: none;
                            }
                            #img-wrapper {
                                transition: transform 0.15s cubic-bezier(0.22, 1, 0.36, 1);
                                will-change: transform;
                            }
                            #preview-img {
                                max-width: 100%;
                                max-height: 100%;
                                object-fit: contain;
                                user-select: none;
                                -webkit-user-drag: none;
                                pointer-events: none;
                            }
                            #preview-controls {
                                position: absolute;
                                bottom: 12px;
                                left: 50%;
                                transform: translateX(-50%);
                                display: flex;
                                gap: 10px;
                                z-index: 10;
                            }
                            .ctrl-btn {
                                background: rgba(0, 0, 0, 0.7);
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 6px 12px;
                                cursor: pointer;
                                font-size: 14px;
                                transition: all 0.2s ease;
                            }
                            .ctrl-btn:hover {
                                background: rgba(0, 0, 0, 0.85);
                                transform: scale(1.05);
                            }
                            /* 预览框右上角的关闭按钮 */
                            #close-btn {
                                position: absolute;
                                top: 10px;
                                right: 10px;
                                z-index: 10;
                                font-size: 18px;
                                background: rgba(0, 0, 0, 0.6);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 32px;
                                height: 32px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                                transition: background 0.2s ease;
                            }
                            #close-btn:hover {
                                background: rgba(0, 0, 0, 0.85);
                            }
                        </style>
                    `;

                    if (file.fileType && file.fileType.startsWith('image/')) {
                        // 修改：取消关闭按钮注释，确保可以关闭预览窗口
                        const html = `
                            ${styles}
                            <div id="preview-container">
                                <button id="close-btn">&times;</button>
                                <div id="img-wrapper">
                                    <img id="preview-img" src="${fileUrl}" />
                                </div>
                                <div id="preview-controls">
                                    <button class="ctrl-btn" id="zoom-in">放大</button>
                                    <button class="ctrl-btn" id="zoom-out">缩小</button>
                                    <button class="ctrl-btn" id="reset">重置</button>
                                </div>
                            </div>
                        `;

                        let modal;
                        const cleanup = () => {
                            window.URL.revokeObjectURL(fileUrl);
                            if (modal) modal.close();
                        };

                        modal = this.$alert(html, {
                            dangerouslyUseHTMLString: true,
                            customClass: 'image-preview-modal',
                            title: '图片预览',
                            center: true,
                            showClose: false,
                            callback: cleanup
                        });

                        this.$nextTick(() => {
                            const container = document.getElementById('preview-container');
                            const wrapper = document.getElementById('img-wrapper');
                            const image = document.getElementById('preview-img');
                            const zoomInBtn = document.getElementById('zoom-in');
                            const zoomOutBtn = document.getElementById('zoom-out');
                            const resetBtn = document.getElementById('reset');
                            const closeBtn = document.getElementById('close-btn');

                            let scale = 1;
                            let translateX = 0;
                            let translateY = 0;
                            let isDragging = false;
                            let startX = 0;
                            let startY = 0;
                            let initialTranslateX = 0;
                            let initialTranslateY = 0;

                            const applyTransform = () => {
                                wrapper.style.transform = `translate3d(${translateX}px, ${translateY}px, 0) scale(${scale})`;
                            };

                            const smoothApplyTransform = () => {
                                wrapper.style.transition = 'transform 0.15s cubic-bezier(0.22, 1, 0.36, 1)';
                                applyTransform();
                                setTimeout(() => {
                                    wrapper.style.transition = '';
                                }, 150);
                            };

                            const handleZoom = (delta, clientX, clientY) => {
                                const prevScale = scale;
                                scale = Math.max(0.5, Math.min(4, scale + delta));
                                const rect = container.getBoundingClientRect();
                                const offsetX = clientX - rect.left - translateX;
                                const offsetY = clientY - rect.top - translateY;
                                translateX -= offsetX * (scale / prevScale - 1);
                                translateY -= offsetY * (scale / prevScale - 1);
                                smoothApplyTransform();
                            };

                            const onWheel = (e) => {
                                e.preventDefault();
                                handleZoom(e.deltaY > 0 ? -0.1 : 0.1, e.clientX, e.clientY);
                            };

                            const reset = () => {
                                scale = 1;
                                translateX = 0;
                                translateY = 0;
                                smoothApplyTransform();
                            };

                            const onPointerDown = (e) => {
                                e.preventDefault();
                                isDragging = true;
                                startX = e.clientX;
                                startY = e.clientY;
                                initialTranslateX = translateX;
                                initialTranslateY = translateY;
                                container.style.cursor = 'grabbing';

                                const onPointerMove = (e) => {
                                    if (!isDragging) return;
                                    const dx = e.clientX - startX;
                                    const dy = e.clientY - startY;
                                    translateX = initialTranslateX + dx;
                                    translateY = initialTranslateY + dy;
                                    applyTransform();
                                };

                                const onPointerUp = () => {
                                    isDragging = false;
                                    container.style.cursor = 'grab';
                                    container.removeEventListener('pointermove', onPointerMove);
                                    container.removeEventListener('pointerup', onPointerUp);
                                };

                                container.addEventListener('pointermove', onPointerMove);
                                container.addEventListener('pointerup', onPointerUp);
                            };

                            container.addEventListener('wheel', onWheel, { passive: false });
                            container.addEventListener('pointerdown', onPointerDown);

                            zoomInBtn.addEventListener('click', () => handleZoom(0.2, container.clientWidth / 2, container.clientHeight / 2));
                            zoomOutBtn.addEventListener('click', () => handleZoom(-0.2, container.clientWidth / 2, container.clientHeight / 2));
                            resetBtn.addEventListener('click', reset);
                            closeBtn.addEventListener('click', cleanup);

                            container.style.cursor = 'grab';
                            image.onload = reset;
                        });
                    } else if (file.fileType === 'application/pdf') {
                        window.open(fileUrl);
                    } else {
                        this.$message.warning('不支持预览此文件类型');
                        window.URL.revokeObjectURL(fileUrl);
                    }
                }).catch(() => {
                    this.$message.error('预览文件失败');
                });
            },

            // 下载文件
            downloadFile(file) {
                axios.get(`${this.baseURL}/notes/getFiles?fileId=${file.id}&download=true`, {
                    responseType: 'blob'
                }).then(response => {
                    const blob = new Blob([response.data], { type: response.headers['content-type'] });
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = file.originalName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);
                }).catch(error => {
                    this.$message.error('下载文件失败');
                });
            },

            // 获取文件URL
            getFileUrl(fileId) {
                return `${this.baseURL}/notes/getFiles?fileId=${fileId}`;
            },

            // 格式化日期
            formatDate(date) {
                if (!date) return '';
                return dayjs(date).format('YYYY-MM-DD');
            },

            // 格式化日期时间
            formatDateTime(datetime) {
                return dayjs(datetime).format('YYYY-MM-DD HH:mm');
            },

            beforeFileRemove(file) {
                if (file.id) {
                    return this.$confirm(`确定移除 ${file.name} 吗？`, '提示', { type: 'warning' });
                }
                return true;
            },

            handleExceed(files, fileList) {
                this.$message.warning(`最多选择5个文件，当前选择了 ${files.length + fileList.length} 个文件`);
            },

            formatFileSize(size) {
                if (size < 1024) return size + ' B';
                if (size < 1048576) return (size / 1024).toFixed(1) + ' KB';
                return (size / 1048576).toFixed(1) + ' MB';
            },

            // 修改文件处理方法
            handleFileChange(file, fileList) {
                const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
                if (!allowedTypes.includes(file.raw.type)) {
                    this.$message.error('只支持 JPG/PNG/PDF 格式的文件');
                    return false;
                }
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.raw.size > maxSize) {
                    this.$message.error(`文件大小不能超过${(maxSize/1024/1024).toFixed(0)}MB`);
                    return false;
                }
                this.currentNote.uploadFiles = fileList
                    .filter(f => f.raw)
                    .map(f => f.raw);
            },

            handleFileRemove(file, fileList) {
                if (file.id) {
                    this.deletedFiles.push(file.id);
                    this.currentNote.attachedFiles = this.currentNote.attachedFiles.filter(
                        f => f.id !== file.id
                    );
                }
                this.currentNote.uploadFiles = fileList
                    .filter(f => f.raw)
                    .map(f => f.raw);
            },

            // 获取文件图标
            getFileIcon(type) {
                if (!type) return 'el-icon-files';
                if (type.startsWith('image/')) return 'el-icon-picture';
                if (type === 'application/pdf') return 'el-icon-document';
                return 'el-icon-files';
            },

            // 修改分页处理方法（保持当前页码）
            handleTodoPageChange(page) {
                this.todoPager.page = page;
                this.fetchTodos();
            },

            handleNotePageChange(page) {
                this.notePager.page = page;
                this.fetchNotes();
            },

            // 切换展开和收起状态
            toggleExpand(todo) {
                todo.showFullContent = !todo.showFullContent;
            },

            // 切换笔记展开和收起状态
            toggleExpandNote(note) {
                note.showFullContent = !note.showFullContent;
            }
        }
    });
</script>
